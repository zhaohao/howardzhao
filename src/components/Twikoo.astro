---
// src/components/Twikoo.astro
const TWIKOO_ENV_ID = "https://twikoo.zme.life/"; 
---

<div id="tcomment" data-env={TWIKOO_ENV_ID}></div>

<script>
  // 1. 动态加载 Twikoo 脚本的函数
  function loadTwikooScript() {
    return new Promise((resolve) => {
      // 如果脚本已经存在，直接返回
      if (window.twikoo) return resolve(window.twikoo);

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/twikoo@1.6.44/dist/twikoo.all.min.js';
      script.async = true;
      script.onload = () => resolve(window.twikoo);
      document.head.appendChild(script);
    });
  }

  // 2. 初始化 Twikoo 的逻辑
  async function initTwikoo() {
    const container = document.getElementById('tcomment');
    if (container) {
      const envId = container.dataset.env; // 获取 DOM 上的变量值
      await loadTwikooScript();
      
      // @ts-ignore
      window.twikoo.init({
        envId: envId,
        el: '#tcomment',
      });
    }
  }

  // 3. 关键：监听 Astro 页面加载事件
  // astro:page-load 会在首次进入页面和 View Transitions 切换后都触发
  document.addEventListener('astro:page-load', initTwikoo);
</script>

<style>
  #tcomment {
    margin: 4rem auto 2rem;
    max-width: var(--content-width); /* 适配 Fuwari 内容宽度 */
    padding-top: 2rem;
    border-top: 1px dashed var(--line-color, #e5e7eb);
  }
</style>